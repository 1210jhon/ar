<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AR.js A-Frame Location-based</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
  <style>
    #coords {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: #000;
      color: #fff;
      padding: 8px;
      font-family: monospace;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <a-scene vr-mode-ui="enabled: false"
           arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
           renderer="antialias: true; alpha: true">

    <a-camera gps-new-camera rotation-reader></a-camera>

  </a-scene>

  <div id="coords">Esperando coordenadas...</div>

  <script>
    // GeoJSON con puntos y tuber칤as
    const geojson = {
      "type": "FeatureCollection",
      "features": [
        { "type": "Feature", "properties": { "type": "Tanque", "name": "Tanque Principal" }, "geometry": { "type": "Point", "coordinates": [-78.930637, -7.352577] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 1" }, "geometry": { "type": "Point", "coordinates": [-78.930637, -7.352567] } },
        { "type": "Feature", "properties": { "type": "V치lvula", "name": "V치lvula 1" }, "geometry": { "type": "Point", "coordinates": [-78.930627, -7.352577] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 2" }, "geometry": { "type": "Point", "coordinates": [-78.930647, -7.352577] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque - Pozo 1" }, "geometry": { "type": "LineString", "coordinates": [[-78.930637, -7.352577], [-78.930637, -7.352567]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque - V치lvula 1" }, "geometry": { "type": "LineString", "coordinates": [[-78.930637, -7.352577], [-78.930627, -7.352577]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque - Pozo 2" }, "geometry": { "type": "LineString", "coordinates": [[-78.930637, -7.352577], [-78.930647, -7.352577]] } },
    
        { "type": "Feature", "properties": { "type": "Tanque", "name": "Tanque Secundario" }, "geometry": { "type": "Point", "coordinates": [-78.930600, -7.352600] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 3" }, "geometry": { "type": "Point", "coordinates": [-78.930590, -7.352590] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 4" }, "geometry": { "type": "Point", "coordinates": [-78.930580, -7.352580] } },
        { "type": "Feature", "properties": { "type": "V치lvula", "name": "V치lvula 2" }, "geometry": { "type": "Point", "coordinates": [-78.930570, -7.352570] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Secundario - Pozo 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930600, -7.352600], [-78.930590, -7.352590]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Secundario - Pozo 4" }, "geometry": { "type": "LineString", "coordinates": [[-78.930600, -7.352600], [-78.930580, -7.352580]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Secundario - V치lvula 2" }, "geometry": { "type": "LineString", "coordinates": [[-78.930600, -7.352600], [-78.930570, -7.352570]] } },
    
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 5" }, "geometry": { "type": "Point", "coordinates": [-78.930560, -7.352560] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 6" }, "geometry": { "type": "Point", "coordinates": [-78.930550, -7.352550] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 7" }, "geometry": { "type": "Point", "coordinates": [-78.930540, -7.352540] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 8" }, "geometry": { "type": "Point", "coordinates": [-78.930530, -7.352530] } },
        { "type": "Feature", "properties": { "type": "V치lvula", "name": "V치lvula 3" }, "geometry": { "type": "Point", "coordinates": [-78.930520, -7.352520] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Pozo 5 - V치lvula 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930560, -7.352560], [-78.930520, -7.352520]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Pozo 6 - V치lvula 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930550, -7.352550], [-78.930520, -7.352520]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Pozo 7 - V치lvula 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930540, -7.352540], [-78.930520, -7.352520]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Pozo 8 - V치lvula 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930530, -7.352530], [-78.930520, -7.352520]] } },
    
        { "type": "Feature", "properties": { "type": "Tanque", "name": "Tanque Norte" }, "geometry": { "type": "Point", "coordinates": [-78.930700, -7.352500] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 9" }, "geometry": { "type": "Point", "coordinates": [-78.930710, -7.352490] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 10" }, "geometry": { "type": "Point", "coordinates": [-78.930720, -7.352480] } },
        { "type": "Feature", "properties": { "type": "V치lvula", "name": "V치lvula 4" }, "geometry": { "type": "Point", "coordinates": [-78.930730, -7.352470] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Norte - Pozo 9" }, "geometry": { "type": "LineString", "coordinates": [[-78.930700, -7.352500], [-78.930710, -7.352490]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Norte - Pozo 10" }, "geometry": { "type": "LineString", "coordinates": [[-78.930700, -7.352500], [-78.930720, -7.352480]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Norte - V치lvula 4" }, "geometry": { "type": "LineString", "coordinates": [[-78.930700, -7.352500], [-78.930730, -7.352470]] } }
      ]
    }
    const camera = document.querySelector('[gps-new-camera]');
    const coordsDiv = document.getElementById('coords');

    function gpsToMeters(lat1, lon1, lat2, lon2) {
      const R = 6378137; // radio de la Tierra en m
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // distancia en m
    }




    camera.addEventListener('gps-camera-update-position', e => {
      const lat = e.detail.position.latitude.toFixed(6);
      const lon = e.detail.position.longitude.toFixed(6);
      coordsDiv.textContent = `Lat: ${lat}, Lon: ${lon}`;
      console.log("游늸 Posici칩n actual c치mara:", lat, lon);

      if (window._geojsonAdded) return; // Evita duplicados

      geojson.features.forEach(f => {
        if (f.geometry.type === "Point") {
          const [lon, lat] = f.geometry.coordinates;
          const el = document.createElement("a-box");
          el.setAttribute("gps-new-entity-place", `latitude: ${lat}; longitude: ${lon}`);
          el.setAttribute("color", "blue");
          //el.setAttribute("scale", "5 5 5");
          el.setAttribute("width", "0.3");   // 30 cm de ancho
          el.setAttribute("height", "0.5");  // 30 cm de alto
          el.setAttribute("depth", "0.3");   // 30 cm de profundidad
          document.querySelector("a-scene").appendChild(el);
        }

        if (f.geometry.type === "LineString") {
          const coords = f.geometry.coordinates;
          for (let i = 0; i < coords.length - 1; i++) {
            /*const [lon1, lat1] = coords[i];
            const [lon2, lat2] = coords[i + 1];
        
            // Distancia aproximada en metros
            const dx = gpsToMeters(lat1, lon1, lat1, lon2); 
            const dz = gpsToMeters(lat1, lon1, lat2, lon1); 
            const length = Math.sqrt(dx * dx + dz * dz);
        
            // Punto medio en GPS
            const midLat = (lat1 + lat2) / 2;
            const midLon = (lon1 + lon2) / 2;

            const angle = Math.atan2(dz, dx) * (180 / Math.PI);
        
            // Entidad padre para orientaci칩n
            const entity = document.createElement("a-entity");
            entity.setAttribute("gps-new-entity-place", `latitude: ${midLat}; longitude: ${midLon}`);
            entity.setAttribute("look-at", `[gps-new-entity-place='latitude: ${lat2}; longitude: ${lon2}']`);
        
            // Cilindro dentro del padre
            const cylinder = document.createElement("a-cylinder");
            cylinder.setAttribute("radius", 0.02);   // grosor
            cylinder.setAttribute("height", length);
            cylinder.setAttribute("color", "red");
            cylinder.setAttribute("rotation", `0 ${-angle} 90`); // para que se extienda en X-Z
            entity.appendChild(cylinder);
        
            document.querySelector("a-scene").appendChild(entity);*/
            const [lon1, lat1] = coords[i];
            const [lon2, lat2] = coords[i + 1];
        
            // Distancia en metros
            const length = gpsToMeters(lat1, lon1, lat2, lon2);
        
            // --- Entidad en el punto inicial ---
            // --- Entidad en el punto medio ---
            const entity = document.createElement("a-entity");
            entity.setAttribute(
              "gps-new-entity-place",
              `latitude: ${midLat}; longitude: ${midLon}`
            );
            
            // hacemos que mire hacia el punto final
            entity.setAttribute(
              "look-at",
              `[gps-new-entity-place='latitude: ${lat2}; longitude: ${lon2}']`
            );
            
            // --- Cilindro ---
            const cylinder = document.createElement("a-cylinder");
            cylinder.setAttribute("radius", 0.05);   // grosor de la tuber칤a
            cylinder.setAttribute("height", length);
            cylinder.setAttribute("color", "red");
            
            // ya no hace falta rotation ni position manual
            
            entity.appendChild(cylinder);
            document.querySelector("a-scene").appendChild(entity);
          }
        }
    });

      window._geojsonAdded = true;
    });
  </script>
</body>
</html>
