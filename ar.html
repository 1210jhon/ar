<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AR.js A-Frame Location-based</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
  <style>
    #coords {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: #000;
      color: #fff;
      padding: 8px;
      font-family: monospace;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <a-scene vr-mode-ui="enabled: false"
           arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
           renderer="antialias: true; alpha: true">

    <a-camera gps-new-camera rotation-reader></a-camera>

  </a-scene>

  <div id="coords">Esperando coordenadas...</div>

  <script>
    // GeoJSON con puntos y tuber칤as
    const geojson = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": { "type": "Tanque", "name": "Tanque Principal" },
      "geometry": {
        "type": "Point",
        "coordinates": [-78.930637, -7.352577] // posici칩n inicial
      }
    },
    {
      "type": "Feature",
      "properties": { "type": "Pozo", "name": "Pozo 1" },
      "geometry": {
        "type": "Point",
        "coordinates": [-78.930637, -7.352567] // ~1 m al norte
      }
    },
    {
      "type": "Feature",
      "properties": { "type": "V치lvula", "name": "V치lvula 1" },
      "geometry": {
        "type": "Point",
        "coordinates": [-78.930627, -7.352577] // ~1 m al este
      }
    },
    {
      "type": "Feature",
      "properties": { "type": "Pozo", "name": "Pozo 2" },
      "geometry": {
        "type": "Point",
        "coordinates": [-78.930647, -7.352577] // ~1 m al oeste
      }
    },
    {
      "type": "Feature",
      "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque - Pozo 1" },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [-78.930637, -7.352577],
          [-78.930637, -7.352567]
        ]
      }
    },
    {
      "type": "Feature",
      "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque - V치lvula 1" },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [-78.930637, -7.352577],
          [-78.930627, -7.352577]
        ]
      }
    },
    {
      "type": "Feature",
      "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque - Pozo 2" },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [-78.930637, -7.352577],
          [-78.930647, -7.352577]
        ]
      }
    }
  ]
};
    const camera = document.querySelector('[gps-new-camera]');
    const coordsDiv = document.getElementById('coords');

    function gpsToMeters(lat1, lon1, lat2, lon2) {
      const R = 6378137; // radio de la Tierra en m
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // distancia en m
    }


    camera.addEventListener('gps-camera-update-position', e => {
      const lat = e.detail.position.latitude.toFixed(6);
      const lon = e.detail.position.longitude.toFixed(6);
      coordsDiv.textContent = `Lat: ${lat}, Lon: ${lon}`;
      console.log("游늸 Posici칩n actual c치mara:", lat, lon);

      if (window._geojsonAdded) return; // Evita duplicados

      geojson.features.forEach(f => {
        if (f.geometry.type === "Point") {
          const [lon, lat] = f.geometry.coordinates;
          const el = document.createElement("a-box");
          el.setAttribute("gps-new-entity-place", `latitude: ${lat}; longitude: ${lon}`);
          el.setAttribute("color", "blue");
          //el.setAttribute("scale", "5 5 5");
          el.setAttribute("width", "0.3");   // 30 cm de ancho
          el.setAttribute("height", "0.5");  // 30 cm de alto
          el.setAttribute("depth", "0.3");   // 30 cm de profundidad
          document.querySelector("a-scene").appendChild(el);
        }

        if (f.geometry.type === "LineString") {
          const coords = f.geometry.coordinates;
          for (let i = 0; i < coords.length - 1; i++) {
            const [lon1, lat1] = coords[i];
            const [lon2, lat2] = coords[i + 1];
        
            // Distancia en metros en X/Z
            const dx = gpsToMeters(lat1, lon1, lat1, lon2); 
            const dz = gpsToMeters(lat1, lon1, lat2, lon1); 
            const length = Math.sqrt(dx * dx + dz * dz);
        
            // Punto medio
            const midX = dx / 2;
            const midZ = dz / 2;
        
            // Crear cilindro
            const cylinder = document.createElement("a-cylinder");
            cylinder.setAttribute("gps-new-entity-place", `latitude: ${lat1}; longitude: ${lon1}`);
            cylinder.setAttribute("radius", 0.1); // grosor de la tuber칤a (10 cm)
            cylinder.setAttribute("height", length); 
            cylinder.setAttribute("color", "red");
        
            // Colocar el cilindro en el punto medio
            cylinder.setAttribute("position", `${midX} ${length/2} ${-midZ}`);
        
            // Rotaci칩n correcta
            const angle = Math.atan2(dz, dx) * (180 / Math.PI);
            cylinder.setAttribute("rotation", `0 ${-angle} 90`);
        
            document.querySelector("a-scene").appendChild(cylinder);
          }
        }
    });

      window._geojsonAdded = true;
    });
  </script>
</body>
</html>
