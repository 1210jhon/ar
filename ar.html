<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Drenajes — Location Based</title>
    <!-- A-Frame y AR.js (location-based) -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script type="text/javascript"
        src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
    <script type="text/javascript"
        src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        a-scene {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <!-- Escena AR.js location-based -->
    <a-scene vr-mode-ui='enabled: false' embedded arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false'
        renderer='antialias: true; alpha: true'>

        <!-- Cámara gps-new-camera (convierte lat/lon a coordenadas 3D) -->
        <a-camera gps-new-camera rotation-reader></a-camera>

    </a-scene>

    <script>
        /*
          Ejemplo mínimo: carga un GeoJSON en memoria y crea una entidad (tanque)
          en la posición indicada. Reemplaza las coordenadas de `geojson.features`
          por las de tu drenaje (ojo: GeoJSON usa [lon, lat]).
    
          NOTAS IMPORTANTES:
          - Sirve sólo si la página está en HTTPS o en localhost.
          - Prueba en Chrome (Android) — en iOS hay más limitaciones.
          - Permite cámara y ubicación cuando el navegador lo solicite.
        */

        const geojson = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": { "type": "Tanque", "name": "Tanque Principal" },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-78.5088512, -7.1532544]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "type": "Pozo", "name": "Pozo 1" },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-78.5087000, -7.1532000]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "type": "Válvula", "name": "Válvula 1" },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-78.5090000, -7.1533000]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "type": "Pozo", "name": "Pozo 2" },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-78.5089500, -7.1531000]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "type": "Tubería", "name": "Conexión Tanque - Pozo 1" },
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            [-78.5088512, -7.1532544],
                            [-78.5087000, -7.1532000]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "type": "Tubería", "name": "Conexión Tanque - Válvula 1" },
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            [-78.5088512, -7.1532544],
                            [-78.5090000, -7.1533000]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": { "type": "Tubería", "name": "Conexión Tanque - Pozo 2" },
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            [-78.5088512, -7.1532544],
                            [-78.5089500, -7.1531000]
                        ]
                    }
                }
            ]
        };

        window.onload = () => {
            const scene = document.querySelector('a-scene');
            const camera = document.querySelector('[gps-new-camera]');

            if (!scene || !camera) {
                console.error('No se encontró la escena o la cámara GPS.');
                return;
            }

            // Evento cuando la cámara obtiene la posición GPS
            camera.addEventListener('gps-camera-update-position', function (e) {
                if (window._drenajes_added) return; // evitar duplicados

                console.log('Posición inicial GPS obtenida:', e.detail.position);

                geojson.features.forEach(f => {
                    if (f.geometry.type === "Point") {
                        const [lon, lat] = f.geometry.coordinates;
                        const name = f.properties.name || "Elemento";

                        const el = document.createElement("a-box");
                        el.setAttribute("gps-entity-place", `latitude: ${lat}; longitude: ${lon}`);
                        el.setAttribute("color", "blue");
                        el.setAttribute("depth", "5");
                        el.setAttribute("height", "5");
                        el.setAttribute("width", "5");
                        el.setAttribute("scale", "5 5 5");

                        document.querySelector("a-scene").appendChild(el);
                    }

                    if (f.geometry.type === "LineString") {
                        const coords = f.geometry.coordinates;

                        for (let i = 0; i < coords.length - 1; i++) {
                            const [lon1, lat1] = coords[i];
                            const [lon2, lat2] = coords[i + 1];

                            // Por ahora, solo ponemos marcadores en cada punto intermedio
                            const el = document.createElement("a-sphere");
                            el.setAttribute("gps-entity-place", `latitude: ${lat2}; longitude: ${lon2}`);
                            el.setAttribute("radius", "2");
                            el.setAttribute("color", "red");

                            document.querySelector("a-scene").appendChild(el);
                        }
                    }
                });

                window._drenajes_added = true;

            });
        };
    </script>
</body>

</html>
