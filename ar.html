<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AR.js A-Frame Location-based</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
  <style>
    #coords {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: #000;
      color: #fff;
      padding: 8px;
      font-family: monospace;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <a-scene vr-mode-ui="enabled: false"
           arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
           renderer="antialias: true; alpha: true">

    <a-camera gps-new-camera rotation-reader></a-camera>

  </a-scene>

  <div id="coords">Esperando coordenadas...</div>

  <script>
    // GeoJSON con puntos y tuber칤as
    const geojson = {
      "type": "FeatureCollection",
      "features": [
        // Tanque Principal
        { "type": "Feature", "properties": { "type": "Tanque", "name": "Tanque Principal" }, "geometry": { "type": "Point", "coordinates": [-78.930637, -7.352577] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 1" }, "geometry": { "type": "Point", "coordinates": [-78.930637, -7.352847] } },
        { "type": "Feature", "properties": { "type": "V치lvula", "name": "V치lvula 1" }, "geometry": { "type": "Point", "coordinates": [-78.930367, -7.352577] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 2" }, "geometry": { "type": "Point", "coordinates": [-78.930907, -7.352577] } },
    
        // Tuber칤as del Tanque Principal
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque - Pozo 1" }, "geometry": { "type": "LineString", "coordinates": [[-78.930637, -7.352577], [-78.930637, -7.352847]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque - V치lvula 1" }, "geometry": { "type": "LineString", "coordinates": [[-78.930637, -7.352577], [-78.930367, -7.352577]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque - Pozo 2" }, "geometry": { "type": "LineString", "coordinates": [[-78.930637, -7.352577], [-78.930907, -7.352577]] } },
    
        // Tanque Secundario
        { "type": "Feature", "properties": { "type": "Tanque", "name": "Tanque Secundario" }, "geometry": { "type": "Point", "coordinates": [-78.930557, -7.352647] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 3" }, "geometry": { "type": "Point", "coordinates": [-78.930517, -7.352607] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 4" }, "geometry": { "type": "Point", "coordinates": [-78.930597, -7.352597] } },
        { "type": "Feature", "properties": { "type": "V치lvula", "name": "V치lvula 2" }, "geometry": { "type": "Point", "coordinates": [-78.930587, -7.352567] } },
    
        // Tuber칤as del Tanque Secundario
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Secundario - Pozo 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930557, -7.352647], [-78.930517, -7.352607]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Secundario - Pozo 4" }, "geometry": { "type": "LineString", "coordinates": [[-78.930557, -7.352647], [-78.930597, -7.352597]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Secundario - V치lvula 2" }, "geometry": { "type": "LineString", "coordinates": [[-78.930557, -7.352647], [-78.930587, -7.352567]] } },
    
        // Pozos adicionales
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 5" }, "geometry": { "type": "Point", "coordinates": [-78.930497, -7.352537] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 6" }, "geometry": { "type": "Point", "coordinates": [-78.930467, -7.352517] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 7" }, "geometry": { "type": "Point", "coordinates": [-78.930437, -7.352497] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 8" }, "geometry": { "type": "Point", "coordinates": [-78.930407, -7.352477] } },
        { "type": "Feature", "properties": { "type": "V치lvula", "name": "V치lvula 3" }, "geometry": { "type": "Point", "coordinates": [-78.930377, -7.352457] } },
    
        // Tuber칤as pozos a v치lvula 3
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Pozo 5 - V치lvula 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930497, -7.352537], [-78.930377, -7.352457]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Pozo 6 - V치lvula 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930467, -7.352517], [-78.930377, -7.352457]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Pozo 7 - V치lvula 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930437, -7.352497], [-78.930377, -7.352457]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Pozo 8 - V치lvula 3" }, "geometry": { "type": "LineString", "coordinates": [[-78.930407, -7.352477], [-78.930377, -7.352457]] } },
    
        // Tanque Norte
        { "type": "Feature", "properties": { "type": "Tanque", "name": "Tanque Norte" }, "geometry": { "type": "Point", "coordinates": [-78.930807, -7.352477] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 9" }, "geometry": { "type": "Point", "coordinates": [-78.930837, -7.352447] } },
        { "type": "Feature", "properties": { "type": "Pozo", "name": "Pozo 10" }, "geometry": { "type": "Point", "coordinates": [-78.930867, -7.352417] } },
        { "type": "Feature", "properties": { "type": "V치lvula", "name": "V치lvula 4" }, "geometry": { "type": "Point", "coordinates": [-78.930897, -7.352387] } },
    
        // Tuber칤as Tanque Norte
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Norte - Pozo 9" }, "geometry": { "type": "LineString", "coordinates": [[-78.930807, -7.352477], [-78.930837, -7.352447]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Norte - Pozo 10" }, "geometry": { "type": "LineString", "coordinates": [[-78.930807, -7.352477], [-78.930867, -7.352417]] } },
        { "type": "Feature", "properties": { "type": "Tuber칤a", "name": "Conexi칩n Tanque Norte - V치lvula 4" }, "geometry": { "type": "LineString", "coordinates": [[-78.930807, -7.352477], [-78.930897, -7.352387]] } }
      ]
    };
    const camera = document.querySelector('[gps-new-camera]');
    const coordsDiv = document.getElementById('coords');

    function gpsToMeters(lat1, lon1, lat2, lon2) {
      const R = 6378137; // radio de la Tierra en m
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // distancia en m
    }




    camera.addEventListener('gps-camera-update-position', e => {
      const lat = e.detail.position.latitude.toFixed(6);
      const lon = e.detail.position.longitude.toFixed(6);
      coordsDiv.textContent = `Lat: ${lat}, Lon: ${lon}`;
      console.log("游늸 Posici칩n actual c치mara:", lat, lon);

      if (window._geojsonAdded) return; // Evita duplicados

      geojson.features.forEach(f => {
        if (f.geometry.type === "Point") {
          const [lon, lat] = f.geometry.coordinates;
          const entity = document.createElement("a-entity");
          entity.setAttribute("gps-new-entity-place", `latitude: ${lat}; longitude: ${lon}`);
          
          // Cubo
          const box = document.createElement("a-box");
          box.setAttribute("color", "blue");
          box.setAttribute("width", "0.3");
          box.setAttribute("height", "0.5");
          box.setAttribute("depth", "0.3");
          entity.appendChild(box);
          
          // Texto
          const text = document.createElement("a-text");
          text.setAttribute("value", f.properties.name);
          text.setAttribute("color", "black");
          text.setAttribute("align", "center");
          text.setAttribute("position", "0 0.6 0"); // arriba del cubo
          entity.appendChild(text);
          
          // Agregar todo a la escena
          document.querySelector("a-scene").appendChild(entity);
        }

        if (f.geometry.type === "LineString") {
          const coords = f.geometry.coordinates;
          for (let i = 0; i < coords.length - 1; i++) {
            const [lon1, lat1] = coords[i];
            const [lon2, lat2] = coords[i + 1];
        
            // Distancia en metros
            const length = gpsToMeters(lat1, lon1, lat2, lon2);
        
            // Punto medio en GPS (para posicionar el cilindro)
            const midLat = (lat1 + lat2) / 2;
            const midLon = (lon1 + lon2) / 2;
        
            // Diferencias para calcular 치ngulo
            const dx = lon2 - lon1;
            const dz = lat2 - lat1;
        
            // 츼ngulo horizontal en grados
            const angleY = Math.atan2(dz, dx) * (180 / Math.PI);
        
            // Entidad padre para orientaci칩n
            const entity = document.createElement("a-entity");
            entity.setAttribute(
              "gps-new-entity-place",
              `latitude: ${midLat}; longitude: ${midLon}`
            );
            entity.setAttribute(
              "look-at",
              `[gps-new-entity-place='latitude: ${lat2}; longitude: ${lon2}']`
            );
        
            // Cilindro que representa la tuber칤a
            const cylinder = document.createElement("a-cylinder");
            cylinder.setAttribute("radius", 0.05);   // grosor
            cylinder.setAttribute("height", length);
            cylinder.setAttribute("color", "red");
        
            // Rotaci칩n correcta para que el cilindro apunte de inicio a fin
            cylinder.setAttribute("rotation", `0 ${angleY} 90`);
        
            // A침adimos al padre y a la escena
            entity.appendChild(cylinder);
            document.querySelector("a-scene").appendChild(entity);
          }
        }
    });

      window._geojsonAdded = true;
    });
  </script>
</body>
</html>
